version: "2.1"
services:
    db:
      image: mysql:8.0.27
      ports:
        - "3307:3306"
      volumes:
        - ./mysql-data:/var/lib/mysql
      environment:
        - MYSQL_ROOT_PASSWORD=password
      healthcheck:
        test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
        timeout: 20s
        retries: 10
    elasticsearch:
      image: docker.elastic.co/elasticsearch/elasticsearch:7.10.1
      hostname: elasticsearch
      ports:
        - "9201:9200"
      environment:
        - bootstrap.memory_lock=true
        - xpack.security.enabled=false
        - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
        - "http.host=0.0.0.0"
        - "transport.host=127.0.0.1"
      ulimits:
        memlock:
          soft: -1
          hard: -1
        nofile:
          soft: 65536
          hard: 65536
      mem_limit: 1g
      volumes:
        - /usr/share/elasticsearch/data
      healthcheck:
        test: curl -f http://localhost:9200 || exit 1
        interval: 2s
        timeout: 5s
        retries: 30
    redis:
      image: 'redis:alpine'
      command: redis-server
      ports:
        - '6380:6379'
    app:
      build: .
      command: bash -c "cron -f & rails db:create; rails db:migrate; rake searchkick:reindex CLASS=Message; rm -f tmp/pids/server.pid && bundle exec sidekiq & bundle exec rails s -p 3000 -b '0.0.0.0'"
      environment:
        - RAILS_ENV=development
        - REDIS_URL=redis://redis:6379/0
        - ELASTICSEARCH_URL=http://elasticsearch:9200
        - DB_USER=root
        - DB_NAME=jett-api_development
        - DB_PASSWORD=password
      ports:
        - "3000:3000"
      volumes:
        - ".:/jett-api"
      links:
        - "db"
        - "elasticsearch"
        - "redis"
      depends_on:
        db:
          condition: service_healthy
        elasticsearch:
          condition: service_healthy
